<aside class="toc-sidebar">
  <nav class="toc" aria-label="Table of Contents">
    <h3 class="toc-title">On this page</h3>
    <ul class="toc-list" id="toc-list">
      <!-- Generated by JavaScript -->
    </ul>
  </nav>
</aside>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const article = document.querySelector('.prose');
    const tocList = document.getElementById('toc-list');

    if (!article || !tocList) return;

    // Get all h2 and h3 headings
    const headings = article.querySelectorAll('h2, h3');

    if (headings.length === 0) {
      // Hide TOC if no headings
      const tocSidebar = document.querySelector('.toc-sidebar');
      if (tocSidebar) {
        tocSidebar.style.display = 'none';
      }
      return;
    }

    // Generate TOC items
    headings.forEach(function(heading, index) {
      // Add ID to heading if not present
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }

      // Create TOC item
      const li = document.createElement('li');
      li.className = 'toc-item toc-' + heading.tagName.toLowerCase();

      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.className = 'toc-link';
      a.textContent = heading.textContent;

      // Smooth scroll on click
      a.addEventListener('click', function(e) {
        e.preventDefault();
        const target = document.getElementById(heading.id);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          // Update URL hash
          history.pushState(null, null, '#' + heading.id);
        }
      });

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Intersection Observer for active state
    const observerOptions = {
      root: null,
      rootMargin: '-80px 0px -80% 0px',
      threshold: 0
    };

    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        const id = entry.target.id;
        const link = tocList.querySelector('a[href="#' + id + '"]');

        if (link) {
          if (entry.isIntersecting) {
            // Remove active from all
            tocList.querySelectorAll('.toc-link').forEach(function(l) {
              l.classList.remove('active');
            });
            // Add active to current
            link.classList.add('active');
          }
        }
      });
    }, observerOptions);

    // Observe all headings
    headings.forEach(function(heading) {
      observer.observe(heading);
    });
  });
})();
</script>
